#{extends '/DoS/ui/MCP/main.html' /}
#{set title:'Delving object Server' /}

<div id="header">
  <form method="GET" action="/@dos/browse">
    <label for="path">Path</label>
    <input id="path" name="path" type="text" value=${params.path} />
    <input type="submit" value="Refresh"/>
  </form>
</div>

<hr/>

<div id="browser">
  <table>
    #{list files, as:'file'}
    #{if file.isDir}
    <tr>
      <td><a href="@{dos.ui.MCP.browse(file.path)}">${file.name}</a></td>
      <td>
        <button data-bind="click: function() { makeThumbnails('${file.path}'); }">Make thumbnails</button>
      </td>
    </tr>
    #{/if}
    #{else}
    <tr>
      <td><img src="/thumbnail/${file.id()}" width="80" height="80"/></td>
      <td>${file.name}</td>
    </tr>
    #{/else}
    #{/list}
  </table>
</div>

<hr/>

<div id="footer">
  <div id="queue" style="float: left;" data-bind="template: 'taskListTemplate'"></div>
  <div id="log" style="float: right;">
    Blablabla
  </div>
</div>

<script type="text/html" id="taskListTemplate">
  <table>
    <th>Da Task Path</th>
    <th>Da Actions</th>
    {{each queued()}}
    <tr>
      <td data-bind="text: path"></td>
      <td>
        <button data-bind="click: function() { cancel(_id); }">Cancel</button>
      </td>
    </tr>
    {{/each}}
  </table>
</script>

<script type="text/javascript">
  $(document).ready(function() {

    var viewModel = {
      queued: ko.observableArray([]),
      makeThumbnails: function(path) {
        $.ajax({
          url: '@{dos.ui.Tasks.add()}',
          data: {
            path: path,
            taskType: 'thumbnails'
          },
          success: function(addedTask) {
            viewModel.queued.push(addedTask);
          }
        });
      },
      cancel: function(id) {
        $.ajax({
          url: '/@dos/task/cancel',
          data: {id: id},
          type: 'DELETE',
          success: function() {
            viewModel.queued.remove(function(item) {
              return item._id == id;
            });
          }
        });
      }
    };

    $.getJSON('/@dos/task/list/queued', function(data) {
      viewModel.queued(data.tasks);
    });

    ko.applyBindings(viewModel);

  });
</script>