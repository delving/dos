#{extends '/DoS/ui/MCP/main.html' /}
#{set title:'Delving object Server' /}

<div id="header">
  <form method="GET" action="/@dos/browse">
    <label for="path">Path</label>
    <input id="path" name="path" type="text" value=${params.path}/>
    <input type="submit" value="Refresh"/>
  </form>
</div>

<hr/>

<div id="browser">
  <table>
    #{list files, as:'file'}
    #{if file.isDir}
    <tr>
      <td><a href="@{dos.ui.MCP.browse(file.path)}">${file.name}</a></td>
      <td>
        <button data-bind="click: function() { makeThumbnails('${file.path}'); }">Make thumbnails</button>
      </td>
    </tr>
    #{/if}
    #{else}
    <tr>
      <td><img src="/thumbnail/${file.id()}" width="80" height="80"/></td>
      <td>${file.name}</td>
    </tr>
    #{/else}
    #{/list}
  </table>
</div>

<hr/>

<div id="footer">
  <div id="tasks" style="float: left;" data-bind="template: 'taskListTemplate'"></div>
  <div id="log" style="float: right;" data-bind="template: 'logTemplate'"></div>
</div>

<script type="text/html" id="taskListTemplate">
  <h3>Running task</h3>
  <table>
    <th>Da Task Path</th>
    <th>Da Task Type</th>
    <th>Da Actions</th>
    <th>Progress</th>
    {{each running()}}
    <tr>
      <td data-bind="text: path"></td>
      <td data-bind="text: taskType.name"></td>
      <td>
        <a href="#" data-bind="click: function() { showLogs(_id); }">Show logs</a>
      </td>
      <td>
        <div id="runningProgress"></div>
      </td>
    </tr>
    {{/each}}
  </table>
  <h3>Queued tasks</h3>
  <table>
    <th>Da Task Path</th>
    <th>Da Task Type</th>
    <th>Da Actions</th>
    {{each queued()}}
    <tr>
      <td data-bind="text: path"></td>
      <td data-bind="text: taskType.name"></td>
      <td>
        <button data-bind="click: function() { cancel(_id); }">Cancel</button>
      </td>
    </tr>
    {{/each}}
  </table>
  <h3>Finished tasks</h3>
  <table>
    <th>Da Task Path</th>
    <th>Da Task Type</th>
    <th>Da Actions</th>
    {{each finished()}}
    <tr>
      <td data-bind="text: path"></td>
      <td data-bind="text: taskType.name"></td>
      <td><a href="#" data-bind="click: function() { showLogs(_id); }">Show logs</a></td>
    </tr>
    {{/each}}
  </table>
</script>

<script type="text/html" id="logTemplate">
  {{each logs()}}
  <div data-bind="text: message"></div>
  {{/each}}
</script>

<script type="text/javascript">
  $(document).ready(function() {

    var viewModel = {
      watchedTask: ko.observable(),
      running: ko.observableArray([]),
      queued: ko.observableArray([]),
      finished: ko.observableArray([]),
      logs: ko.observableArray([]),
      makeThumbnails: function(path) {
        $.ajax({
          url: '@{dos.ui.Tasks.add()}',
          data: {
            path: path,
            taskType: 'thumbnails'
          },
          type: 'PUT',
          success: function(addedTask) {
            viewModel.queued.push(addedTask);
          }
        });
      },
      cancel: function(id) {
        $.ajax({
          url: '/@dos/task/cancel',
          data: {id: id},
          type: 'DELETE',
          success: function() {
            viewModel.queued.remove(function(item) {
              return item._id == id;
            });
          }
        });
      },
      showLogs: function(id) {
        $.get('/@dos/log/list/' + id, function(data) {
          viewModel.logs(data.logs);
        });
      }
    };

    ko.applyBindings(viewModel);

    $('#tasks').smartupdater({
      url : '/@dos/task/list',
      minTimeout: 2000
    }, function (d) {
      var data = $.parseJSON(d);
      viewModel.running(data.running);
      viewModel.queued(data.queued);
      viewModel.finished(data.finished);
      viewModel.watchedTask(viewModel.running[0]);

      if (data.running.length > 0) {
        $('#runningProgress').progressbar();
        $('#runningProgress').smartupdater({
          url: '/@dos/task/status/' + data.running[0]._id,
          minTimeout: 1500,
        }, function(d) {
          var data = $.parseJSON(d);
          $('#runningProgress').progressbar('value', data.percentage);
        });
      }
    });
  });
</script>